name: "build-docker-images"
on:
  schedule:
    - cron: "0 0 * * *"
  push:
    paths:
      - ".github/workflows/build-docker-images.yml"
      - ".github/docker-compose.yml"
      - "contrib/docker/Dockerfile"
      - "lib/*.ps1"
  workflow_dispatch:
env:
  DOCKER_BUILDKIT: 0
jobs:
  nanoserver:
    name: "build and push nanoserver docker image"
    runs-on: windows-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: "Login to Docker Hub"
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: "build docker image"
        env:
          USER: code
        run: >
          docker-compose 
          -f .github/docker-compose.yml
          build 
          --build-arg "user=$Env:USER"
          pwsh-nanoserver
      - name: "push docker image"
        run: >
          docker-compose
          -f .github/docker-compose.yml
          push
          pwsh-nanoserver
  servercore:
    name: "build and push servercore docker image"
    runs-on: windows-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: "Login to Docker Hub"
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: "build docker image"
        env:
          USER: code
        run: >
          docker-compose 
          -f .github/docker-compose.yml
          build 
          --build-arg "user=$Env:USER"
          pwsh-servercore
      - name: "push docker image"
        run: >
          docker-compose
          -f .github/docker-compose.yml
          push
          pwsh-servercore
  windows:
    name: "build and push windows docker image"
    runs-on: windows-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: "Login to Docker Hub"
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: "build docker image"
        env:
          USER: code
        run: >
          docker-compose 
          -f .github/docker-compose.yml
          build 
          --build-arg "user=$Env:USER"
          pwsh-windows
      - name: "push docker image"
        run: >
          docker-compose
          -f .github/docker-compose.yml
          push
          pwsh-windows
